#!/usr/bin/env python
# -*- coding:utf-8 -*-

'''

www.kugou.com/yy/rank/home/1-8888.html

// 列表数据
global.features = [{"Hash":"FC5E16730504E41E1684D5EE563B6EB0","FileName":"\u9ed1\u9f99 - 38\u5ea66","timeLen":191.019,"privilege":10,"size":3059635,"album_id":9423867,"encrypt_id":"ootaieb"},{"Hash":"8CE93AE627B955F091008F0DB3CBE0C1","FileName":"\u534a\u9633 - \u6d41\u6d6a","timeLen":219.009,"privilege":10,"size":3505946,"album_id":8714026,"encrypt_id":"ndiin31"},{"Hash":"0D0CD85787B2988DC372A315EFD632FC","FileName":"\u5c55\u5c55\u4e0e\u7f57\u7f57 - \u6c99\u6f20\u9a86\u9a7c","timeLen":338,"privilege":10,"size":5409859,"album_id":2713184,"encrypt_id":"g3d726a"},{"Hash":"96E064A41AB84EBE4C03C6AAE3CB9334","FileName":"\u5f20\u7d2b\u8c6a - \u53ef\u4e0d\u53ef\u4ee5","timeLen":240.093,"privilege":10,"size":3855453,"album_id":9618875,"encrypt_id":"mkt6v7f"},{"Hash":"59D0561C75CE3CE720D033B47BCE2043","FileName":"\u738b\u5927\u6bdb - \u53bb\u5e74\u590f\u5929","timeLen":245.005,"privilege":10,"size":3921416,"album_id":8542577,"encrypt_id":"mlcina9"},{"Hash":"BEDD046FB30A0C443CD6F854574B065E","FileName":"\u706b\u7bad\u5c11\u5973101 - \u5361\u8def\u91cc","timeLen":232.008,"privilege":0,"size":3713839,"album_id":9175221,"encrypt_id":"o35k304"},{"Hash":"A48C513A23A7283FC015F9E7774FE3B0","FileName":"Christine Welch - \u4e00\u767e\u4e07\u4e2a\u53ef\u80fd","timeLen":275,"privilege":10,"size":4409886,"album_id":970316,"encrypt_id":"2pgtbd9"},{"Hash":"238B786A3F93C42E3D212953E1CE96C3","FileName":"\u4e8e\u6587\u6587 - \u4f53\u9762","timeLen":282.08,"privilege":10,"size":4525288,"album_id":8149034,"encrypt_id":"litny53"},{"Hash":"3158FF178E0B9CC25A0446C4A61F0230","FileName":"\u674e\u8363\u6d69 - \u5e74\u5c11\u6709\u4e3a","timeLen":279.035,"privilege":10,"size":4470186,"album_id":8873395,"encrypt_id":"nv3syf7"},{"Hash":"34C7777FFFDD4FDF04E02AF1F6857CA4","FileName":"G.E.M.\u9093\u7d2b\u68cb - \u5149\u5e74\u4e4b\u5916","timeLen":235,"privilege":0,"size":3767365,"album_id":1952211,"encrypt_id":"eoo8m01"},{"Hash":"3B624E3FA7D00DB2ADD082598CE8A981","FileName":"\u5c0f\u6f58\u6f58\u3001\u5c0f\u5cf0\u5cf0 - \u5b66\u732b\u53eb","timeLen":209.026,"privilege":10,"size":3348525,"album_id":8496641,"encrypt_id":"mfv56b9"},{"Hash":"B507808B800A5413C0E8C165AC52DE68","FileName":"\u5e84\u5fc3\u598d - \u518d\u89c1\u53ea\u662f\u964c\u751f\u4eba","timeLen":252,"privilege":10,"size":4029424,"album_id":553952,"encrypt_id":"b273d85"},{"Hash":"E6EC7B63B259E5CB3404F421C5B37B78","FileName":"\u7b80\u5f18\u4ea6 - \u4e0d\u67d3","timeLen":325.085,"privilege":10,"size":5214215,"album_id":9193101,"encrypt_id":"osjz946"},{"Hash":"ED7A8444EBA24738F5CCB9B8F87A61D3","FileName":"\u738b\u5317\u8f66 - \u9677\u9631","timeLen":280.099,"privilege":10,"size":4496431,"album_id":8747471,"encrypt_id":"ngbn41a"},{"Hash":"C509BCA5D1C1B2CF2B6192F58EC73646","FileName":"\u963f\u91cc\u90ce - \u9694\u58c1\u6cf0\u5c71","timeLen":199.06,"privilege":10,"size":3194157,"album_id":8696149,"encrypt_id":"n9vjgc2"},{"Hash":"58F5CDC383D7E2B52642CEABC24BD6FE","FileName":"\u9a6c\u826f\u3001\u5b59\u831c\u8339 - \u5f80\u540e\u4f59\u751f","timeLen":236.062,"privilege":10,"size":3786403,"album_id":10746733,"encrypt_id":"q6fa29c"},{"Hash":"1DE6EA56083A013A6649DA68E0418E20","FileName":"\u5f20\u5317\u5317 - \u62e5\u62b1\u4f60\u79bb\u53bb","timeLen":242,"privilege":10,"size":3882206,"album_id":2637534,"encrypt_id":"b8rfh51"},{"Hash":"5C1BB55CCD20F85AA9816DAA7649BDEF","FileName":"\u80e166 - \u7a7a\u7a7a\u5982\u4e5f","timeLen":211.057,"privilege":10,"size":3385675,"album_id":8114346,"encrypt_id":"lfyi01a"},{"Hash":"1543CB6EEBB01A574FB2957481445C9D","FileName":"\u8881\u5a05\u7ef4 - \u8bf4\u6563\u5c31\u6563","timeLen":242.06,"privilege":10,"size":3882101,"album_id":8025931,"encrypt_id":"l8twoe8"},{"Hash":"8F56CA836F9DB53661861DD6253385D1","FileName":"\u4e5d\u5c40 - \u6211\u5df2\u7ecf\u7231\u4e0a\u4f60","timeLen":92,"privilege":10,"size":1472514,"album_id":9001653,"encrypt_id":"o227837"},{"Hash":"D1067071ED850BA3E906DFF08F16244C","FileName":"\u5e7f\u4e1c\u96e8\u795e - \u5e7f\u4e1c\u7231\u60c5\u6545\u4e8b","timeLen":214,"privilege":10,"size":3429399,"album_id":4162049,"encrypt_id":"hdust1f"},{"Hash":"61F5F660CD7F4C7EF8CFE5B828D20FCB","FileName":"Fitz &amp; The Tantrums - HandClap","timeLen":192,"privilege":10,"size":3091882,"album_id":1847794,"encrypt_id":"cjij5ca"}];


http://wwwapi.kugou.com/yy/index.php?r=play/getdata&callback=jQuery191007401245460459349&hash=FC5E16730504E41E1684D5EE563B6EB0&album_id=9423867

https://blog.csdn.net/hanshoukai/article/details/80544285

https://blog.csdn.net/meinaozi/article/details/79955652

'''

import requests
import re
import json
import pymongo


client = pymongo.MongoClient(host='localhost',port=27017)

db = client.spiders

collection = db['song']


headers={
    "Host": "www.kugou.com",
    "Referer":"www.kugou.com",
    "User-Agent": "Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Safari/537.36"
}

def parse_mp3_url(mp3_data):
    api ="http://wwwapi.kugou.com/yy/index.php?r=play/getdata&callback=jQuery191007401245460459349&hash={}&album_id={}".format(mp3_data['Hash'],mp3_data['album_id'])
    res = requests.get(api,headers=headers)
    if res.status_code ==200:
        m=re.search(r'\w+\((.*?)\);',res.text,re.DOTALL|re.M|re.S)
        mp3_json_string = m.group(1)
        try:
            mp3_json = json.loads(mp3_json_string)
            list =  {
                "audio_name":mp3_json['data']['audio_name'],
                "album_name":mp3_json['data']['album_name'],
                "have_mv":mp3_json['data']['have_mv'],
                "img":mp3_json['data']['img'],
                "author_name":mp3_json['data']['author_name'],
                "song_name":mp3_json['data']['song_name'],
                "timelength":mp3_json['data']['timelength'],
                "play_url":mp3_json['data']['play_url']
              }
            return list
        except:
            print('error!')


def get_list(url):
    global table
    resp = requests.get(url,headers=headers)
    data = resp.text
    d = re.search(r'global.features =(.*?);.*?\(function',data,re.DOTALL|re.M|re.S)
    lists = d.group(1)
    try:
        lists = json.loads(lists)
        for mp3_data in lists:
            song_json = parse_mp3_url(mp3_data)
            if song_json:
                try:
                    result1 = collection.insert(song_json)
                    print(result1)
                except:

                    print('insert error!')
            else:
                print('parse error')

    except:
        print('json error')


if __name__ == "__main__":
    base_url = "http://www.kugou.com/yy/rank/home/{}-8888.html"
    for i in range(1,23):
        url = base_url.format(i)
        print('正在下載...',url)
        get_list(url)